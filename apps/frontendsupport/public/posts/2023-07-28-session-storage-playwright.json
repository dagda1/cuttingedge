{
  "html": "<p><a href=\"https://playwright.dev/\">Playwright</a> is my choice for end-to-end (e2e) testing. A common problem in any end-to-end testing framework is authenticating or logging in a user before each test. However, Playwright has a great solution by giving an API to store the authenticated browser state in the page context's <a href=\"https://playwright.dev/docs/api/class-apirequestcontext#api-request-context-storage-state\">storageState</a>. The <code>storageState</code> contains a snapshot of the current cookies and localStorage.</p>\n<p>If this authenticated browser state, e.g. an authentication token, is stored in localStorage or cookies, then Playright <a href=\"https://playwright.dev/docs/auth#core-concepts\">has you covered</a>.</p>\n<p>If, however, you use <code>sessionStorage</code>, then unfortunately, this is not covered. The <a href=\"https://playwright.dev/docs/auth#session-storage\">docs</a> say that using sessionStoarge to store authentication tokens is rare, which differs from my experience.</p>\n<p>The docs do, though, give a <a href=\"https://playwright.dev/docs/auth#session-storage\">code snippet</a>(below) that took me a while to understand, and it is really two snippets, one for persisting the sessionStorage and one for rehydrating the sessionStorage before each test.</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-comment\">// Get session storage and store as env variable</span>\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable language_\">sessionStorage</span> = <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">evaluate</span>(<span class=\"hljs-function\">() =></span>\n  <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>(<span class=\"hljs-variable language_\">sessionStorage</span>)\n);\nfs.<span class=\"hljs-title function_\">writeFileSync</span>(\n  <span class=\"hljs-string\">\"playwright/.auth/session.json\"</span>,\n  <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>(<span class=\"hljs-variable language_\">sessionStorage</span>),\n  <span class=\"hljs-string\">\"utf-8\"</span>\n);\n\n<span class=\"hljs-comment\">// Set session storage in a new context</span>\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable language_\">sessionStorage</span> = <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">parse</span>(\n  fs.<span class=\"hljs-title function_\">readFileSync</span>(<span class=\"hljs-string\">\"playwright/.auth/session.json\"</span>, <span class=\"hljs-string\">\"utf-8\"</span>)\n);\n<span class=\"hljs-keyword\">await</span> context.<span class=\"hljs-title function_\">addInitScript</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">storage</span>) =></span> {\n  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">location</span>.<span class=\"hljs-property\">hostname</span> === <span class=\"hljs-string\">\"example.com\"</span>) {\n    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> [key, value] <span class=\"hljs-keyword\">of</span> <span class=\"hljs-built_in\">object</span>.<span class=\"hljs-title function_\">entries</span>(storage))\n      <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">sessionStorage</span>.<span class=\"hljs-title function_\">setItem</span>(key, value);\n  }\n}, <span class=\"hljs-variable language_\">sessionStorage</span>);\n</code></pre>\n<p>I will give step-by-step instructions that remove the confusion and ambiguity.</p>\n<h2>Project references</h2>\n<p>The first step in persisting authentication state across tests is to create a test that logs the user in and uses <a href=\"https://playwright.dev/docs/next/test-projects#dependencies\">Playright project dependencies</a> to ensure that the login test runs before any other.</p>\n<p>Project dependencies are a list of projects that need to run before the tests in another project run.</p>\n<pre><code class=\"hljs language-ts:./playwright.config.ts\">projects: [\n  {\n    name: 'setup',\n    testMatch: '**/*.setup.ts',\n  },\n  {\n    name: 'e2e tests logged in',\n    testMatch: '**/*.spec.ts',\n    dependencies: ['setup'],\n  },\n],\n</code></pre>\n<p>With this configuration, any tests that match the <code>'**/*.setup.ts'</code> glob will run before any tests that match the <code>'**/*.spec.ts'</code> glob.</p>\n<h2>Store authentication state in sessionStorage</h2>\n<p>Below is the test file, <code>login.setup.ts</code>, that logs the user in:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">import</span> { test <span class=\"hljs-keyword\">as</span> setup, expect } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"@playwright/test\"</span>;\n<span class=\"hljs-keyword\">import</span> fs <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"fs\"</span>;\n\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">STORAGE_STATE</span> = path.<span class=\"hljs-title function_\">join</span>(__dirname, <span class=\"hljs-string\">\"playwright/.auth/auth.json\"</span>);\n\n<span class=\"hljs-title function_\">setup</span>(<span class=\"hljs-string\">\"authenticate\"</span>, <span class=\"hljs-title function_\">async</span> ({ page }) => {\n  <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">goto</span>(<span class=\"hljs-string\">\"/\"</span>);\n  <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">getByRole</span>(<span class=\"hljs-string\">\"textbox\"</span>, { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">\"SOEID\"</span> }).<span class=\"hljs-title function_\">fill</span>(<span class=\"hljs-string\">\"test\"</span>);\n  <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">getByRole</span>(<span class=\"hljs-string\">\"textbox\"</span>, { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">\"Password\"</span> }).<span class=\"hljs-title function_\">fill</span>(<span class=\"hljs-string\">\"test\"</span>);\n  <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-property\">keyboard</span>.<span class=\"hljs-title function_\">press</span>(<span class=\"hljs-string\">\"Enter\"</span>);\n\n  <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">expect</span>(page.<span class=\"hljs-title function_\">locator</span>(<span class=\"hljs-string\">'[href*=\"/parodos\"]'</span>)).<span class=\"hljs-title function_\">toBeVisible</span>();\n\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable language_\">sessionStorage</span> = <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">evaluate</span>(<span class=\"hljs-function\">() =></span>\n    <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>(<span class=\"hljs-variable language_\">sessionStorage</span>)\n  );\n\n  fs.<span class=\"hljs-title function_\">writeFileSync</span>(<span class=\"hljs-variable constant_\">STORAGE_STATE</span>, <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>(<span class=\"hljs-variable language_\">sessionStorage</span>), <span class=\"hljs-string\">\"utf-8\"</span>);\n});\n</code></pre>\n<p>I've aliased the Playwright <code>test</code> object to <code>setup</code> to make it clear that this test is different from the rest:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">import</span> { test <span class=\"hljs-keyword\">as</span> setup, expect } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"@playwright/test\"</span>;\n</code></pre>\n<p>The first task in persisting the sessionStorage is to persist a snapshot of the current sessionStorage to a file at the following location:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">STORAGE_STATE</span> = path.<span class=\"hljs-title function_\">join</span>(__dirname, <span class=\"hljs-string\">\"playwright/.auth/auth.json\"</span>);\n</code></pre>\n<p>After the test runs, the following code retrieves the sessionStorage state and saves it to a file in the path specified above:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable language_\">sessionStorage</span> = <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">evaluate</span>(<span class=\"hljs-function\">() =></span>\n  <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>(<span class=\"hljs-variable language_\">sessionStorage</span>)\n);\n\nfs.<span class=\"hljs-title function_\">writeFileSync</span>(<span class=\"hljs-variable constant_\">STORAGE_STATE</span>, <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>(<span class=\"hljs-variable language_\">sessionStorage</span>), <span class=\"hljs-string\">\"utf-8\"</span>);\n</code></pre>\n<p><a href=\"https://playwright.dev/docs/evaluating\">page.evaluate()</a> can execute the javascript to retrieve the current sessionStorage state from the browser.</p>\n<h2>Rehydrating sessionStorage before each test</h2>\n<p>We want to avoid copying and pasting similar code in each test that requires the user to be logged in. We want to avoid including the code to read in the file and setting the sessionStorage in every test without resorting to sloppy copy and paste.</p>\n<p>Playwright's <a href=\"https://playwright.dev/docs/test-fixtures\">fixtures</a> establish an environment for each test, giving the test everything it needs</p>\n<p>Below is the <code>sessionStorage.ts</code> fixture that retrieves the previously saved sessionStorage state from the file and then initializes the browser sessionStorage with the JSON in the file.</p>\n<pre><code class=\"hljs language-ts:sessionStorage.ts\">import fs from 'fs';\nimport { test as base } from '@playwright/test';\nimport { STORAGE_STATE } from '../playwright.config';\n\nexport const test = base.extend({\n  context: async ({ context }, use) => {\n    const sessionStorage = JSON.parse(fs.readFileSync(STORAGE_STATE, 'utf-8'));\n\n    await context.addInitScript(storage => {\n      for (const [key, value] of object.entries(JSON.parse(storage))) {\n        window.sessionStorage.setItem(key, value);\n      }\n    }, sessionStorage);\n\n    use(context);\n  },\n});\n</code></pre>\n<p>The code above uses the context's <a href=\"https://playwright.dev/docs/api/class-browsercontext#browser-context-add-init-script\"><code>addInitScript function</code></a>, which can add a client-side script to the current page.</p>\n<p>The script turns the file contents into a JSON object and updates the browser sessionStoage with the contents.</p>\n<p>With this in place, we can run and pass tests without calling any additional code.</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">import</span> { expect } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"@playwright/test\"</span>;\n<span class=\"hljs-keyword\">import</span> { test } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"./sessionStorage\"</span>;\n\ntest.<span class=\"hljs-title function_\">describe</span>(<span class=\"hljs-string\">\"/parodos\"</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-title function_\">test</span>(<span class=\"hljs-string\">\"should render projects page\"</span>, <span class=\"hljs-title function_\">async</span> ({ page }) => {\n    <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">goto</span>(<span class=\"hljs-string\">`/`</span>);\n\n    <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">expect</span>(page.<span class=\"hljs-title function_\">locator</span>(<span class=\"hljs-string\">'[href*=\"/parodos\"]'</span>)).<span class=\"hljs-title function_\">toBeVisible</span>();\n\n    page.<span class=\"hljs-title function_\">locator</span>(<span class=\"hljs-string\">'[href*=\"/parodos\"]'</span>).<span class=\"hljs-title function_\">click</span>();\n\n    <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">waitForSelector</span>(<span class=\"hljs-string\">\"data-testid=header-title\"</span>);\n\n    <span class=\"hljs-title function_\">expect</span>(page.<span class=\"hljs-title function_\">url</span>()).<span class=\"hljs-title function_\">toContain</span>(<span class=\"hljs-string\">`/parodos`</span>);\n\n    <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">getByRole</span>(<span class=\"hljs-string\">\"button\"</span>, { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">\"Add new project\"</span> }).<span class=\"hljs-title function_\">click</span>();\n\n    <span class=\"hljs-keyword\">await</span> page.<span class=\"hljs-title function_\">waitForSelector</span>(<span class=\"hljs-string\">\"data-testid=create-project\"</span>);\n  });\n});\n</code></pre>\n<p>The critical thing to note is that we are importing the extended test from the fixture file and not from Playright itself:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">import</span> { test } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"./sessionStorage\"</span>;\n</code></pre>\n<h2>Epilogue</h2>\n<p>It is a pity that Playwright's <code>storageState</code> does not support sessionStorage but it is possible with the steps outlined above.</p>",
  "frontmatter": {
    "meta": {
      "title": "Store authentication state across Playwright tests in applications that use sessionStorage",
      "description": "How to store authentication state across tests if your application stores tokens in sessionStorage.",
      "date": "2023-07-31T00:00:00.000Z",
      "image": "https://res.cloudinary.com/ddospxsc8/image/upload/v1690741574/playwright_iofvmm.png",
      "tags": ["playwright", "testing"]
    }
  }
}
