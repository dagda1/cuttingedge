{
  "html": "<h2>Know your performance metrics on every commit</h2>\n<p>In a recent post titled <a href=\"https://frontendrescue.com/posts/2023-09-04-5-things-to-automate\">5 Things that should be Automated in a TypeScript/Javascript Monorepo</a>, I mentioned the importance of automating performance metrics.</p>\n<p>I have a GitHub action that adds performance metrics as a comment to a pull request on every commit. I use <a href=\"https://www.webpagetest.org/\">webpagetest</a> to run the tests, and the results highlight the unnecessary loading of all the large images on the website you are currently viewing's home page.</p>\n<p><img src=\"https://res.cloudinary.com/ddospxsc8/image/upload/v1695914718/webpagetest-images_glttuy.png\" alt=\"webpage test results\">.</p>\n<p>The home page is comprised of five large background images, each filling the whole viewport as the user scrolls down. Loading all these images up front is a wasteful performance hit. A better idea is to lazy load the images as the user scrolls down the page.</p>\n<h2>Why not use the img tag's loading attribute?</h2>\n<p>The loading attribute on an <code>&#x3C;img></code> element can instruct the browser to defer the loading of off-screen images until the user scrolls near them.</p>\n<pre><code class=\"hljs language-html\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"image.jpg\"</span> <span class=\"hljs-attr\">alt</span>=<span class=\"hljs-string\">\"lazy loaded\"</span> <span class=\"hljs-attr\">loading</span>=<span class=\"hljs-string\">\"lazy\"</span> /></span>\n</code></pre>\n<p>Unfortunately, the large images in question are set using the <code>background-image</code> CSS property:</p>\n<pre><code class=\"hljs language-css\"><span class=\"hljs-attribute\">background-image</span>: <span class=\"hljs-built_in\">url</span>(<span class=\"hljs-string\">https://res.cloudinary.com/666/image/upload/v66/struggle_yderkl.png</span>);\n</code></pre>\n<h2>Low Quality Image Placeholders (LQIP)</h2>\n<p>Lazy loading is one part of the challenge, and another is to prevent the user from staring at a blank space until the image has loaded. It is currently good practice to provide a low-quality blurred image that bares a representation of the actual image, as you can see on my blog listing below:</p>\n<p><img src=\"https://res.cloudinary.com/ddospxsc8/image/upload/v1695918932/blurhash_vnbpuj.png\" alt=\"blurred images\">.</p>\n<p>A low-quality placeholder resembling the original image fills the space until the actual images are loaded and ready to view. The placeholder has significantly less download size in kilobytes.</p>\n<p>Once the image has loaded, the placeholder is replaced with the actual image.</p>\n<p><img src=\"https://res.cloudinary.com/ddospxsc8/image/upload/v1696001710/posts_vz2ffl.png\" alt=\"real images\"></p>\n<p>The <a href=\"https://github.com/woltapp/blurhash\">blurhash</a> package can help us create a low-quality image placeholder from an image.</p>\n<h3>blurhash</h3>\n<p><a href=\"https://blurha.sh/\">blurhash</a> generates compact representations of a placeholder for an image. Developing blurhashes is an expensive operation and not the sort you want to do at runtime. All the images on this website are stored in <a href=\"https://cloudinary.com/ip/gr-sea-gg-brand-home-base\">cloudinary</a>, so I created <a href=\"https://www.npmjs.com/package/@cutting/cloudinary-blurhash\">this npm package</a> that will iterate all the images of a Cloudinary account and create a JSON file with the image properties and the burhash that looks like this:</p>\n<pre><code class=\"hljs language-json\"><span class=\"hljs-punctuation\">[</span>\n  <span class=\"hljs-punctuation\">{</span>\n    <span class=\"hljs-attr\">\"id\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"blurhash_vnbpuj.png\"</span><span class=\"hljs-punctuation\">,</span>\n    <span class=\"hljs-attr\">\"url\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"https://res.cloudinary.com/acc/image/upload/v666/blurhash.png\"</span><span class=\"hljs-punctuation\">,</span>\n    <span class=\"hljs-attr\">\"blurhash\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"UG8}0+_N-;xvxaocWAaxIVIVIUM{WBfRWAWB\"</span><span class=\"hljs-punctuation\">,</span>\n    <span class=\"hljs-attr\">\"width\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">600</span><span class=\"hljs-punctuation\">,</span>\n    <span class=\"hljs-attr\">\"height\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">231</span>\n  <span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n  ...\n<span class=\"hljs-punctuation\">]</span>\n</code></pre>\n<p>The JSON file negates the need to create the <a href=\"https://blurha.sh\">blurhash</a> at runtime.</p>\n<p><a href=\"https://blurha.sh/\">BlurHash</a> takes an image and gives you a short string (only 20-30 characters!) that represents the placeholder for this image. The string is highlighted on line 5 of the JSON in the above sample, which my <a href=\"https://www.npmjs.com/package/@cutting/cloudinary-blurhash\">npm package</a> package generated.</p>\n<p>For HTML <code>img</code> elements, I use the <code>LazyLoadedImage</code> component that is listed below:</p>\n<pre><code class=\"hljs language-tsx\"><span class=\"hljs-keyword\">import</span> { blurhashToGradientCssObject } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"@unpic/placeholder\"</span>;\n<span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Image</span>, <span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">ImageProps</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"@unpic/react\"</span>;\n<span class=\"hljs-keyword\">import</span> { useMemo } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"react\"</span>;\n<span class=\"hljs-keyword\">import</span> { getImagePropsFromMap } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"./getImagePropsFromMap\"</span>;\n\n<span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">Layout</span> = <span class=\"hljs-title class_\">ImageProps</span>[<span class=\"hljs-string\">\"layout\"</span>];\n\n<span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">LazyLoadedImageProps</span> = <span class=\"hljs-title class_\">Omit</span>&#x3C;<span class=\"hljs-title class_\">ImageProps</span>, <span class=\"hljs-string\">\"layout\"</span>> &#x26; {\n  <span class=\"hljs-attr\">layout</span>?: <span class=\"hljs-title class_\">Layout</span>;\n} &#x26; <span class=\"hljs-title class_\">React</span>.<span class=\"hljs-property\">RefAttributes</span>&#x3C;<span class=\"hljs-title class_\">HTMLImageElement</span>>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">LazyLoadedImage</span>(<span class=\"hljs-params\">{\n  src,\n  width,\n  height,\n  loading = <span class=\"hljs-string\">\"lazy\"</span>,\n  layout = <span class=\"hljs-string\">\"constrained\"</span>,\n  ...props\n}: <span class=\"hljs-title class_\">LazyLoadedImageProps</span></span>): <span class=\"hljs-variable constant_\">JSX</span>.<span class=\"hljs-property\">Element</span> {\n  <span class=\"hljs-keyword\">const</span> image = <span class=\"hljs-title function_\">getImagePropsFromMap</span>(src);\n\n  <span class=\"hljs-keyword\">const</span> { blurhash, ...imageProps } = image;\n\n  <span class=\"hljs-keyword\">const</span> placeholderStyle = <span class=\"hljs-title function_\">useMemo</span>(\n    <span class=\"hljs-function\">() =></span> <span class=\"hljs-title function_\">blurhashToGradientCssObject</span>(blurhash),\n    [blurhash]\n  );\n\n  <span class=\"hljs-keyword\">return</span> (\n    <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">Image</span>\n      <span class=\"hljs-attr\">loading</span>=<span class=\"hljs-string\">{loading}</span>\n      <span class=\"hljs-attr\">layout</span>=<span class=\"hljs-string\">{layout</span> <span class=\"hljs-attr\">as</span> <span class=\"hljs-attr\">any</span>}\n      <span class=\"hljs-attr\">width</span>=<span class=\"hljs-string\">{width</span> ?? <span class=\"hljs-attr\">imageProps.width</span>}\n      <span class=\"hljs-attr\">height</span>=<span class=\"hljs-string\">{height</span> ?? <span class=\"hljs-attr\">imageProps.height</span>}\n      <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">{placeholderStyle}</span>\n      <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">{src}</span>\n      {<span class=\"hljs-attr\">...props</span>}\n    /></span></span>\n  );\n}\n</code></pre>\n<p>I use <a href=\"https://github.com/ascorbic/unpic-placeholder\">@unpic/placeholder</a> to transform the <a href=\"https://blurha.sh/\">blurhash</a> into a style object that I pass as a prop to the <a href=\"https://github.com/ascorbic/unpic-img\">@unpic/react</a> <code>Image</code> component that I use for responsive images.</p>\n<p>I get the <a href=\"https://blurha.sh/\">blurhash</a> from the JSON file I generated with my package on line 18 of the above code sample.</p>\n<p>The <code>blurhashToGradientCssObject</code> function will return the style object from the <a href=\"https://blurha.sh/\">blurhash</a> on line 22.</p>\n<p>The rendered <code>img</code> tag and style attribute will look something like this:</p>\n<pre><code class=\"hljs language-HTML\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">loading</span>=<span class=\"hljs-string\">\"lazy\"</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"object-fit:cover;max-width:600px;max-height:400px;aspect-ratio:1.5;width:100%;background-image:radial-gradient(at 0 0,#ffffff,#00000000 50%),radial-gradient(at 33% 0,#fefefc,#00000000 50%),radial-gradient(at 67% 0,#edecee,#00000000 50%),radial-gradient(at 100% 0,#f4f4f6,#00000000 50%),radial-gradient(at 0 50%,#fdfffe,#00000000 50%),radial-gradient(at 33% 50%,#f9f8f7,#00000000 50%),radial-gradient(at 67% 50%,#e5e6e9,#00000000 50%),radial-gradient(at 100% 50%,#edeef1,#00000000 50%),radial-gradient(at 0 100%,#fbffff,#00000000 50%),radial-gradient(at 33% 100%,#fafbfa,#00000000 50%),radial-gradient(at 67% 100%,#e0e5eb,#00000000 50%),radial-gradient(at 100% 100%,#e4eaf1,#00000000 50%)\"</span> <span class=\"hljs-attr\">decoding</span>=<span class=\"hljs-string\">\"async\"</span> <span class=\"hljs-attr\">sizes</span>=<span class=\"hljs-string\">\"(min-width: 600px) 600px, 100vw\"</span> <span class=\"hljs-attr\">srcset</span>=<span class=\"hljs-string\">\"&#x3C;rest>\"</span>></span>\n</code></pre>\n<p>That takes care of the best practices for low-quality blurred image placeholders.</p>\n<h2>Can we please get to the IntersectionObserver!!</h2>\n<p>When the image is set with the <code>background-image</code> CSS property, lazy loading the image is a little trickier, and this is when the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API\">IntersectionObserver</a> finally makes an appearance.</p>\n<p>The IntersectionObserver API is relatively new in browsers. It makes it simple to detect when an element enters the viewport, and you can execute a callback when it does.</p>\n<p>I use the following <code>LazyBackgroundImage</code> component:</p>\n<pre><code class=\"hljs language-tsx\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title class_\">LazyBackgroundImageProps</span> {\n  <span class=\"hljs-attr\">backgroundImage</span>: <span class=\"hljs-built_in\">string</span>;\n}\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">LazyBackgroundImage</span>(<span class=\"hljs-params\">{\n  backgroundImage,\n}: <span class=\"hljs-title class_\">LazyBackgroundImageProps</span></span>): <span class=\"hljs-variable constant_\">JSX</span>.<span class=\"hljs-property\">Element</span> {\n  <span class=\"hljs-keyword\">const</span> containerRef = useRef&#x3C;<span class=\"hljs-title class_\">HTMLDivElement</span>>(<span class=\"hljs-literal\">null</span>);\n  <span class=\"hljs-keyword\">const</span> [visible, setVisible] = <span class=\"hljs-title function_\">useState</span>(<span class=\"hljs-literal\">false</span>);\n\n  <span class=\"hljs-keyword\">const</span> callback = <span class=\"hljs-title function_\">useCallback</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\"><span class=\"hljs-attr\">entries</span>: <span class=\"hljs-title class_\">IntersectionObserverEntry</span>[]</span>) =></span> {\n    <span class=\"hljs-keyword\">const</span> [entry] = entries;\n\n    <span class=\"hljs-keyword\">if</span> (entry.<span class=\"hljs-property\">isIntersecting</span>) {\n      <span class=\"hljs-title function_\">setVisible</span>(<span class=\"hljs-literal\">true</span>);\n    }\n  }, []);\n\n  <span class=\"hljs-title function_\">useIsomorphicLayoutEffect</span>(<span class=\"hljs-function\">() =></span> {\n    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-variable language_\">global</span>.<span class=\"hljs-property\">IntersectionObserver</span>) {\n      <span class=\"hljs-keyword\">return</span>;\n    }\n\n    <span class=\"hljs-keyword\">const</span> observer = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">IntersectionObserver</span>(callback, {\n      <span class=\"hljs-attr\">rootMargin</span>: <span class=\"hljs-string\">\"0px\"</span>,\n      <span class=\"hljs-attr\">threshold</span>: <span class=\"hljs-number\">0.1</span>,\n      <span class=\"hljs-attr\">root</span>: <span class=\"hljs-literal\">null</span>,\n    });\n\n    <span class=\"hljs-keyword\">if</span> (containerRef.<span class=\"hljs-property\">current</span>) {\n      observer.<span class=\"hljs-title function_\">observe</span>(containerRef.<span class=\"hljs-property\">current</span>);\n    }\n\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-function\">() =></span> {\n      <span class=\"hljs-keyword\">if</span> (containerRef.<span class=\"hljs-property\">current</span>) {\n        <span class=\"hljs-comment\">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n        observer.<span class=\"hljs-title function_\">unobserve</span>(containerRef.<span class=\"hljs-property\">current</span>);\n      }\n    };\n  }, [callback]);\n\n  <span class=\"hljs-keyword\">const</span> style = <span class=\"hljs-title function_\">useMemo</span>(<span class=\"hljs-function\">() =></span> {\n    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-variable language_\">global</span>.<span class=\"hljs-property\">IntersectionObserver</span> || visible) {\n      <span class=\"hljs-keyword\">return</span> { <span class=\"hljs-attr\">backgroundImage</span>: <span class=\"hljs-string\">`url(<span class=\"hljs-subst\">${backgroundImage}</span>)`</span> };\n    }\n    <span class=\"hljs-keyword\">const</span> { blurhash } = <span class=\"hljs-title function_\">getImagePropsFromMap</span>(backgroundImage);\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">blurhashToGradientCssObject</span>(blurhash);\n  }, [backgroundImage, visible]);\n\n  <span class=\"hljs-keyword\">return</span> <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">Box</span> <span class=\"hljs-attr\">ref</span>=<span class=\"hljs-string\">{containerRef}</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">{style}</span>></span><span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">Box</span>></span></span>;\n}\n</code></pre>\n<p>Lines 10-16 create a callback that is passed as an argument to the <code>IntersectionObserver</code> constructor:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">const</span> callback = <span class=\"hljs-title function_\">useCallback</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\"><span class=\"hljs-attr\">entries</span>: <span class=\"hljs-title class_\">IntersectionObserverEntry</span>[]</span>) =></span> {\n  <span class=\"hljs-keyword\">const</span> [entry] = entries;\n\n  <span class=\"hljs-keyword\">if</span> (entry.<span class=\"hljs-property\">isIntersecting</span>) {\n    <span class=\"hljs-title function_\">setVisible</span>(<span class=\"hljs-literal\">true</span>);\n  }\n}, []);\n</code></pre>\n<p>The callback is passed an array of <code>IntersectionObserverEntry</code> objects, which are wrappers around any HTML elements that are being observed. The <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserverEntry\">entry</a> has an <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserverEntry/isIntersecting\">isIntersecting</a> property that is true when the element is in the viewport. All the callback does is update the <code>visible</code> property of the local state with the <code>setVisible</code> call when <code>isIntersecting</code> is true, which will cause a re-render with the updated value.</p>\n<p>Lines 23-27 create the intersection observer:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">const</span> observer = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">IntersectionObserver</span>(callback, {\n  <span class=\"hljs-attr\">rootMargin</span>: <span class=\"hljs-string\">\"0px\"</span>,\n  <span class=\"hljs-attr\">threshold</span>: <span class=\"hljs-number\">0.1</span>,\n  <span class=\"hljs-attr\">root</span>: <span class=\"hljs-literal\">null</span>,\n});\n</code></pre>\n<p>On line 30, the observer is told which element to observe.</p>\n<pre><code class=\"hljs language-ts\">observer.<span class=\"hljs-title function_\">observe</span>(containerRef.<span class=\"hljs-property\">current</span>);\n</code></pre>\n<p>On lines 42-46, a style object that initially has the <a href=\"https://blurha.sh/\">blurhash</a> CSS object is created. This object gets swapped for the background image when the observed HTML element is in the viewport.</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">const</span> style = <span class=\"hljs-title function_\">useMemo</span>(<span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-variable language_\">global</span>.<span class=\"hljs-property\">IntersectionObserver</span> || visible) {\n    <span class=\"hljs-keyword\">return</span> { <span class=\"hljs-attr\">backgroundImage</span>: <span class=\"hljs-string\">`url(<span class=\"hljs-subst\">${backgroundImage}</span>)`</span> };\n  }\n  <span class=\"hljs-keyword\">const</span> { blurhash } = <span class=\"hljs-title function_\">getImagePropsFromMap</span>(backgroundImage);\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">blurhashToGradientCssObject</span>(blurhash);\n}, [backgroundImage, visible]);\n\n<span class=\"hljs-keyword\">return</span> <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">Box</span> <span class=\"hljs-attr\">ref</span>=<span class=\"hljs-string\">{containerRef}</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">{style}</span>></span><span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">Box</span>></span></span>;\n</code></pre>\n<h2>TLDR;</h2>\n<p>With a combination of the <code>LazyLoadedImage</code> and the <code>LazyBackgroundImage</code> components, we can load the images on demand as the user scrolls down the screen.</p>\n<p>Only one large background image is loaded when the home page first loads.\n<img src=\"https://res.cloudinary.com/ddospxsc8/image/upload/v1695935341/webpage-results_nmkrr3.png\" alt=\"lazy loaded images\">.\nI consider this case closed.</p>",
  "frontmatter": {
    "meta": {
      "title": "Lazy loading background images with the IntersectionObserver and React with low-quality image placeholders created with blurhash",
      "description": null,
      "date": "2023-09-28T00:00:00.000Z",
      "image": "https://res.cloudinary.com/ddospxsc8/image/upload/v1696266094/homepage_g99jty.png",
      "tags": ["performance", "react", "typescript"]
    }
  }
}
