{
  "html": "<h2>Know your performance metrics on every commit</h2><p>In a recent post titled <a href=https://frontendrescue.com/posts/2023-09-04-5-things-to-automate>5 Things that should be Automated in a TypeScript/Javascript Monorepo</a>, I mentioned the importance of automating performance metrics.<p>I have a GitHub action that adds performance metrics as a comment to a pull request on every commit. I use <a href=https://www.webpagetest.org/>webpagetest</a> to run the tests, and the results highlight the unnecessary loading of all the large images on the website you are currently viewing's home page.<p><img alt=\"webpage test results\"src=https://res.cloudinary.com/ddospxsc8/image/upload/v1695914718/webpagetest-images_glttuy.png>.<p>The home page is comprised of five large background images, each filling the whole viewport as the user scrolls down. Loading all these images up front is a wasteful performance hit. A better idea is to lazy load the images as the user scrolls down the page.<h2>Why not use the img tag's loading attribute?</h2><p>The loading attribute on an <code>&#60img></code> element can instruct the browser to defer the loading of off-screen images until the user scrolls near them.<pre class=language-html><code class=\"code-highlight language-html\"><span class=code-line><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>image.jpg<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">alt</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>lazy loaded<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">loading</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>lazy<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n</span></code></pre><p>Unfortunately, the large images in question are set using the <code>background-image</code> CSS property:<pre class=language-css><code class=\"code-highlight language-css\"><span class=code-line><span class=\"token property\">background-image</span><span class=\"token punctuation\">:</span> <span class=\"token url\"><span class=\"token function\">url</span><span class=\"token punctuation\">(</span>https://res.cloudinary.com/666/image/upload/v66/struggle_yderkl.png<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">;</span>\n</span></code></pre><h2>Low Quality Image Placeholders (LQIP)</h2><p>Lazy loading is one part of the challenge, and another is to prevent the user from staring at a blank space until the image has loaded. It is currently good practice to provide a low-quality blurred image that bares a representation of the actual image, as you can see on my blog listing below:<p><img alt=\"blurred images\"src=https://res.cloudinary.com/ddospxsc8/image/upload/v1695918932/blurhash_vnbpuj.png>.<p>A low-quality placeholder resembling the original image fills the space until the actual images are loaded and ready to view. The placeholder has significantly less download size in kilobytes.<p>Once the image has loaded, the placeholder is replaced with the actual image.<p><img alt=\"real images\"src=https://res.cloudinary.com/ddospxsc8/image/upload/v1696001710/posts_vz2ffl.png><p>The <a href=https://github.com/woltapp/blurhash>blurhash</a> package can help us create a low-quality image placeholder from an image.<h3>blurhash</h3><p><a href=https://blurha.sh/>blurhash</a> generates compact representations of a placeholder for an image. Developing blurhashes is an expensive operation and not the sort you want to do at runtime. All the images on this website are stored in <a href=https://cloudinary.com/ip/gr-sea-gg-brand-home-base>cloudinary</a>, so I created <a href=https://www.npmjs.com/package/@cutting/cloudinary-blurhash>this npm package</a> that will iterate all the images of a Cloudinary account and create a JSON file with the image properties and the burhash that looks like this:<pre class=language-json><code class=\"code-highlight language-json\"><span class=\"code-line line-number\"line=1><span class=\"token punctuation\">[</span>\n</span><span class=\"code-line line-number\"line=2>  <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=3>    <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"blurhash_vnbpuj.png\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=4>    <span class=\"token property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://res.cloudinary.com/acc/image/upload/v666/blurhash.png\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number highlight-line\"line=5>    <span class=\"token property\">\"blurhash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"UG8}0+_N-;xvxaocWAaxIVIVIUM{WBfRWAWB\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=6>    <span class=\"token property\">\"width\"</span><span class=\"token operator\">:</span> <span class=\"token number\">600</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=7>    <span class=\"token property\">\"height\"</span><span class=\"token operator\">:</span> <span class=\"token number\">231</span>\n</span><span class=\"code-line line-number\"line=8>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=9>  ...\n</span><span class=\"code-line line-number\"line=10><span class=\"token punctuation\">]</span>\n</span></code></pre><p>The JSON file negates the need to create the <a href=https://blurha.sh>blurhash</a> at runtime.<p><a href=https://blurha.sh/>BlurHash</a> takes an image and gives you a short string (only 20-30 characters!) that represents the placeholder for this image. The string is highlighted on line 5 of the JSON in the above sample, which my <a href=https://www.npmjs.com/package/@cutting/cloudinary-blurhash>npm package</a> package generated.<p>For HTML <code>img</code> elements, I use the <code>LazyLoadedImage</code> component that is listed below:<pre class=language-tsx><code class=\"code-highlight language-tsx\"><span class=\"code-line line-number highlight-line\"line=1><span class=\"token keyword\">import</span> <span class=\"token imports\"><span class=\"token punctuation\">{</span> blurhashToGradientCssObject <span class=\"token punctuation\">}</span></span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@unpic/placeholder\"</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number highlight-line\"line=2><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token maybe-class-name\">Image</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">ImageProps</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@unpic/react\"</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=3><span class=\"token keyword\">import</span> <span class=\"token imports\"><span class=\"token punctuation\">{</span> useMemo <span class=\"token punctuation\">}</span></span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=4><span class=\"token keyword\">import</span> <span class=\"token imports\"><span class=\"token punctuation\">{</span> getImagePropsFromMap <span class=\"token punctuation\">}</span></span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./getImagePropsFromMap\"</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=5>\n</span><span class=\"code-line line-number\"line=6><span class=\"token keyword\">type</span> <span class=\"token class-name\">Layout</span> <span class=\"token operator\">=</span> <span class=\"token maybe-class-name\">ImageProps</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"layout\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=7>\n</span><span class=\"code-line line-number\"line=8><span class=\"token keyword\">type</span> <span class=\"token class-name\">LazyLoadedImageProps</span> <span class=\"token operator\">=</span> <span class=\"token maybe-class-name\">Omit</span><span class=\"token operator\">&lt;</span><span class=\"token maybe-class-name\">ImageProps</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"layout\"</span><span class=\"token operator\">></span> <span class=\"token operator\">&amp</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=9>  layout<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token maybe-class-name\">Layout</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=10><span class=\"token punctuation\">}</span> <span class=\"token operator\">&amp</span> <span class=\"token maybe-class-name\">React</span><span class=\"token punctuation\">.</span><span class=\"token property-access\"><span class=\"token maybe-class-name\">RefAttributes</span></span><span class=\"token operator\">&lt;</span><span class=\"token maybe-class-name\">HTMLImageElement</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=11>\n</span><span class=\"code-line line-number\"line=12><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">LazyLoadedImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=13>  src<span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=14>  width<span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=15>  height<span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=16>  loading <span class=\"token operator\">=</span> <span class=\"token string\">\"lazy\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=17>  layout <span class=\"token operator\">=</span> <span class=\"token string\">\"constrained\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=18>  <span class=\"token operator spread\">...</span>props\n</span><span class=\"code-line line-number\"line=19><span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> <span class=\"token maybe-class-name\">LazyLoadedImageProps</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span><span class=\"token property-access\"><span class=\"token maybe-class-name\">Element</span></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=20>  <span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token function\">getImagePropsFromMap</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=21>\n</span><span class=\"code-line line-number highlight-line\"line=22>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> blurhash<span class=\"token punctuation\">,</span> <span class=\"token operator spread\">...</span>imageProps <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> image<span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=23>\n</span><span class=\"code-line line-number\"line=24>  <span class=\"token keyword\">const</span> placeholderStyle <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span>\n</span><span class=\"code-line line-number\"line=25>    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator arrow\">=></span> <span class=\"token function\">blurhashToGradientCssObject</span><span class=\"token punctuation\">(</span>blurhash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=26>    <span class=\"token punctuation\">[</span>blurhash<span class=\"token punctuation\">]</span>\n</span><span class=\"code-line line-number\"line=27>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=28>\n</span><span class=\"code-line line-number\"line=29>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n</span><span class=\"code-line line-number highlight-line\"line=30>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Image</span></span>\n</span></span><span class=\"code-line line-number\"line=31><span class=\"token tag\">      <span class=\"token attr-name\">loading</span><span class=\"token language-javascript script\"><span class=\"token punctuation script-punctuation\">=</span><span class=\"token punctuation\">{</span>loading<span class=\"token punctuation\">}</span></span>\n</span></span><span class=\"code-line line-number\"line=32><span class=\"token tag\">      <span class=\"token attr-name\">layout</span><span class=\"token language-javascript script\"><span class=\"token punctuation script-punctuation\">=</span><span class=\"token punctuation\">{</span>layout <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">}</span></span>\n</span></span><span class=\"code-line line-number\"line=33><span class=\"token tag\">      <span class=\"token attr-name\">width</span><span class=\"token language-javascript script\"><span class=\"token punctuation script-punctuation\">=</span><span class=\"token punctuation\">{</span>width <span class=\"token operator\">??</span> imageProps<span class=\"token punctuation\">.</span><span class=\"token property-access\">width</span><span class=\"token punctuation\">}</span></span>\n</span></span><span class=\"code-line line-number\"line=34><span class=\"token tag\">      <span class=\"token attr-name\">height</span><span class=\"token language-javascript script\"><span class=\"token punctuation script-punctuation\">=</span><span class=\"token punctuation\">{</span>height <span class=\"token operator\">??</span> imageProps<span class=\"token punctuation\">.</span><span class=\"token property-access\">height</span><span class=\"token punctuation\">}</span></span>\n</span></span><span class=\"code-line line-number\"line=35><span class=\"token tag\">      <span class=\"token attr-name\">style</span><span class=\"token language-javascript script\"><span class=\"token punctuation script-punctuation\">=</span><span class=\"token punctuation\">{</span>placeholderStyle<span class=\"token punctuation\">}</span></span>\n</span></span><span class=\"code-line line-number\"line=36><span class=\"token tag\">      <span class=\"token attr-name\">src</span><span class=\"token language-javascript script\"><span class=\"token punctuation script-punctuation\">=</span><span class=\"token punctuation\">{</span>src<span class=\"token punctuation\">}</span></span>\n</span></span><span class=\"code-line line-number\"line=37><span class=\"token tag\">      <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator spread\">...</span>props<span class=\"token punctuation\">}</span></span>\n</span></span><span class=\"code-line line-number\"line=38><span class=\"token tag\">    <span class=\"token punctuation\">/></span></span>\n</span><span class=\"code-line line-number\"line=39>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=40><span class=\"token punctuation\">}</span>\n</span></code></pre><p>I use <a href=https://github.com/ascorbic/unpic-placeholder>@unpic/placeholder</a> to transform the <a href=https://blurha.sh/>blurhash</a> into a style object that I pass as a prop to the <a href=https://github.com/ascorbic/unpic-img>@unpic/react</a> <code>Image</code> component that I use for responsive images.<p>I get the <a href=https://blurha.sh/>blurhash</a> from the JSON file I generated with my package on line 18 of the above code sample.<p>The <code>blurhashToGradientCssObject</code> function will return the style object from the <a href=https://blurha.sh/>blurhash</a> on line 22.<p>The rendered <code>img</code> tag and style attribute will look something like this:<pre class=language-html><code class=\"code-highlight language-HTML\"><span class=code-line><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">loading</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>lazy<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token language-css css value\"><span class=\"token property\">object-fit</span><span class=\"token punctuation\">:</span>cover<span class=\"token punctuation\">;</span><span class=\"token property\">max-width</span><span class=\"token punctuation\">:</span><span class=\"token number\">600</span><span class=\"token unit\">px</span><span class=\"token punctuation\">;</span><span class=\"token property\">max-height</span><span class=\"token punctuation\">:</span><span class=\"token number\">400</span><span class=\"token unit\">px</span><span class=\"token punctuation\">;</span><span class=\"token property\">aspect-ratio</span><span class=\"token punctuation\">:</span><span class=\"token number\">1.5</span><span class=\"token punctuation\">;</span><span class=\"token property\">width</span><span class=\"token punctuation\">:</span><span class=\"token number\">100</span><span class=\"token unit\">%</span><span class=\"token punctuation\">;</span><span class=\"token property\">background-image</span><span class=\"token punctuation\">:</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">0</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#ffffff</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">33</span><span class=\"token unit\">%</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#fefefc</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">67</span><span class=\"token unit\">%</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#edecee</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">100</span><span class=\"token unit\">%</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#f4f4f6</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">0</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#fdfffe</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">33</span><span class=\"token unit\">%</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#f9f8f7</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">67</span><span class=\"token unit\">%</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#e5e6e9</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">100</span><span class=\"token unit\">%</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#edeef1</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">0</span> <span class=\"token number\">100</span><span class=\"token unit\">%</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#fbffff</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">33</span><span class=\"token unit\">%</span> <span class=\"token number\">100</span><span class=\"token unit\">%</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#fafbfa</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">67</span><span class=\"token unit\">%</span> <span class=\"token number\">100</span><span class=\"token unit\">%</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#e0e5eb</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">radial-gradient</span><span class=\"token punctuation\">(</span>at <span class=\"token number\">100</span><span class=\"token unit\">%</span> <span class=\"token number\">100</span><span class=\"token unit\">%</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#e4eaf1</span><span class=\"token punctuation\">,</span><span class=\"token color hexcode\">#00000000</span> <span class=\"token number\">50</span><span class=\"token unit\">%</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\"</span></span></span> <span class=\"token attr-name\">decoding</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>async<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">sizes</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>(min-width: 600px) 600px, 100vw<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">srcset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>&#60rest><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n</span></code></pre><p>That takes care of the best practices for low-quality blurred image placeholders.<h2>Can we please get to the IntersectionObserver!!</h2><p>When the image is set with the <code>background-image</code> CSS property, lazy loading the image is a little trickier, and this is when the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API>IntersectionObserver</a> finally makes an appearance.<p>The IntersectionObserver API is relatively new in browsers. It makes it simple to detect when an element enters the viewport, and you can execute a callback when it does.<p>I use the following <code>LazyBackgroundImage</code> component:<pre class=language-tsx><code class=\"code-highlight language-tsx\"><span class=\"code-line line-number\"line=1><span class=\"token keyword\">interface</span> <span class=\"token class-name\">LazyBackgroundImageProps</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=2>  backgroundImage<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=3><span class=\"token punctuation\">}</span>\n</span><span class=\"code-line line-number\"line=4><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">LazyBackgroundImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=5>  backgroundImage<span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number\"line=6><span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> <span class=\"token maybe-class-name\">LazyBackgroundImageProps</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span><span class=\"token property-access\"><span class=\"token maybe-class-name\">Element</span></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=7>  <span class=\"token keyword\">const</span> containerRef <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useRef</span><span class=\"token class-name generic\"><span class=\"token operator\">&lt;</span>HTMLDivElement<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=8>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>visible<span class=\"token punctuation\">,</span> setVisible<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=9>\n</span><span class=\"code-line line-number highlight-line\"line=10>  <span class=\"token keyword\">const</span> callback <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>entries<span class=\"token operator\">:</span> <span class=\"token maybe-class-name\">IntersectionObserverEntry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator arrow\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number highlight-line\"line=11>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>entry<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> entries<span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number highlight-line\"line=12>\n</span><span class=\"code-line line-number highlight-line\"line=13>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token property-access\">isIntersecting</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number highlight-line\"line=14>      <span class=\"token function\">setVisible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number highlight-line\"line=15>    <span class=\"token punctuation\">}</span>\n</span><span class=\"code-line line-number highlight-line\"line=16>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=17>\n</span><span class=\"code-line line-number\"line=18>  <span class=\"token function\">useIsomorphicLayoutEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator arrow\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=19>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>global<span class=\"token punctuation\">.</span><span class=\"token property-access\"><span class=\"token maybe-class-name\">IntersectionObserver</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=20>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=21>    <span class=\"token punctuation\">}</span>\n</span><span class=\"code-line line-number\"line=22>\n</span><span class=\"code-line line-number highlight-line\"line=23>    <span class=\"token keyword\">const</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number highlight-line\"line=24>      rootMargin<span class=\"token operator\">:</span> <span class=\"token string\">\"0px\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number highlight-line\"line=25>      threshold<span class=\"token operator\">:</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number highlight-line\"line=26>      root<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n</span><span class=\"code-line line-number highlight-line\"line=27>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=28>\n</span><span class=\"code-line line-number\"line=29>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>containerRef<span class=\"token punctuation\">.</span><span class=\"token property-access\">current</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number highlight-line\"line=30>      observer<span class=\"token punctuation\">.</span><span class=\"token function property-access method\">observe</span><span class=\"token punctuation\">(</span>containerRef<span class=\"token punctuation\">.</span><span class=\"token property-access\">current</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=31>    <span class=\"token punctuation\">}</span>\n</span><span class=\"code-line line-number\"line=32>\n</span><span class=\"code-line line-number\"line=33>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator arrow\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=34>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>containerRef<span class=\"token punctuation\">.</span><span class=\"token property-access\">current</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=35>        <span class=\"token comment\">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n</span><span class=\"code-line line-number\"line=36>        observer<span class=\"token punctuation\">.</span><span class=\"token function property-access method\">unobserve</span><span class=\"token punctuation\">(</span>containerRef<span class=\"token punctuation\">.</span><span class=\"token property-access\">current</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=37>      <span class=\"token punctuation\">}</span>\n</span><span class=\"code-line line-number\"line=38>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=39>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>callback<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=40>\n</span><span class=\"code-line line-number\"line=41>  <span class=\"token keyword\">const</span> style <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator arrow\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number highlight-line\"line=42>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>global<span class=\"token punctuation\">.</span><span class=\"token property-access\"><span class=\"token maybe-class-name\">IntersectionObserver</span></span> <span class=\"token operator\">||</span> visible<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number highlight-line\"line=43>      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> backgroundImage<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token string template-punctuation\">`</span><span class=\"token string\">url(</span><span class=\"token interpolation\"><span class=\"token punctuation interpolation-punctuation\">${</span>backgroundImage<span class=\"token punctuation interpolation-punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token string template-punctuation\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number highlight-line\"line=44>    <span class=\"token punctuation\">}</span>\n</span><span class=\"code-line line-number highlight-line\"line=45>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> blurhash <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">getImagePropsFromMap</span><span class=\"token punctuation\">(</span>backgroundImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number highlight-line\"line=46>    <span class=\"token keyword\">return</span> <span class=\"token function\">blurhashToGradientCssObject</span><span class=\"token punctuation\">(</span>blurhash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=47>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>backgroundImage<span class=\"token punctuation\">,</span> visible<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=48>\n</span><span class=\"code-line line-number\"line=49>  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Box</span></span> <span class=\"token attr-name\">ref</span><span class=\"token language-javascript script\"><span class=\"token punctuation script-punctuation\">=</span><span class=\"token punctuation\">{</span>containerRef<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">style</span><span class=\"token language-javascript script\"><span class=\"token punctuation script-punctuation\">=</span><span class=\"token punctuation\">{</span>style<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#60/</span><span class=\"token class-name\">Box</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=50><span class=\"token punctuation\">}</span>\n</span></code></pre><p>Lines 10-16 create a callback that is passed as an argument to the <code>IntersectionObserver</code> constructor:<pre class=language-ts><code class=\"code-highlight language-ts\"><span class=\"code-line line-number\"line=1><span class=\"token keyword\">const</span> callback <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>entries<span class=\"token operator\">:</span> IntersectionObserverEntry<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=2>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>entry<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> entries<span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=3>\n</span><span class=\"code-line line-number\"line=4>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span>isIntersecting<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line line-number\"line=5>    <span class=\"token function\">setVisible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"code-line line-number\"line=6>  <span class=\"token punctuation\">}</span>\n</span><span class=\"code-line line-number\"line=7><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></code></pre><p>The callback is passed an array of <code>IntersectionObserverEntry</code> objects, which are wrappers around any HTML elements that are being observed. The <a href=https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserverEntry>entry</a> has an <a href=https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserverEntry/isIntersecting>isIntersecting</a> property that is true when the element is in the viewport. All the callback does is update the <code>visible</code> property of the local state with the <code>setVisible</code> call when <code>isIntersecting</code> is true, which will cause a re-render with the updated value.<p>Lines 23-27 create the intersection observer:<pre class=language-ts><code class=\"code-highlight language-ts\"><span class=code-line><span class=\"token keyword\">const</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n</span><span class=code-line>  rootMargin<span class=\"token operator\">:</span> <span class=\"token string\">\"0px\"</span><span class=\"token punctuation\">,</span>\n</span><span class=code-line>  threshold<span class=\"token operator\">:</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">,</span>\n</span><span class=code-line>  root<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n</span><span class=code-line><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></code></pre><p>On line 30, the observer is told which element to observe.<pre class=language-ts><code class=\"code-highlight language-ts\"><span class=code-line>observer<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>containerRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></code></pre><p>On lines 42-46, a style object that initially has the <a href=https://blurha.sh/>blurhash</a> CSS object is created. This object gets swapped for the background image when the observed HTML element is in the viewport.<pre class=language-ts><code class=\"code-highlight language-ts\"><span class=code-line><span class=\"token keyword\">const</span> style <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=code-line>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>global<span class=\"token punctuation\">.</span>IntersectionObserver <span class=\"token operator\">||</span> visible<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=code-line>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> backgroundImage<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token string template-punctuation\">`</span><span class=\"token string\">url(</span><span class=\"token interpolation\"><span class=\"token punctuation interpolation-punctuation\">${</span>backgroundImage<span class=\"token punctuation interpolation-punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token string template-punctuation\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</span><span class=code-line>  <span class=\"token punctuation\">}</span>\n</span><span class=code-line>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> blurhash <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">getImagePropsFromMap</span><span class=\"token punctuation\">(</span>backgroundImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=code-line>  <span class=\"token keyword\">return</span> <span class=\"token function\">blurhashToGradientCssObject</span><span class=\"token punctuation\">(</span>blurhash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=code-line><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>backgroundImage<span class=\"token punctuation\">,</span> visible<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=code-line>\n</span><span class=code-line><span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>Box ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>containerRef<span class=\"token punctuation\">}</span> style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>style<span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Box<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n</span></code></pre><h2>TLDR;</h2><p>With a combination of the <code>LazyLoadedImage</code> and the <code>LazyBackgroundImage</code> components, we can load the images on demand as the user scrolls down the screen.<p>Only one large background image is loaded when the home page first loads.<br><img alt=\"lazy loaded images\"src=https://res.cloudinary.com/ddospxsc8/image/upload/v1695935341/webpage-results_nmkrr3.png>.<br>I consider this case closed.",
  "frontmatter": {
    "meta": {
      "title": "Lazy loading background images with the IntersectionObserver and React with low-quality image placeholders created with blurhash",
      "description": null,
      "date": "2023-09-28T00:00:00.000Z",
      "image": "https://res.cloudinary.com/ddospxsc8/image/upload/v1696266094/homepage_g99jty.png",
      "tags": ["performance", "react", "typescript"]
    }
  }
}
