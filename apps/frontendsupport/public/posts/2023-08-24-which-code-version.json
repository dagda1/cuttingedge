{
  "html": "<p>It is common to have multiple staging, UAT and production environments running different code versions. Knowing which version of the frontend code is in which environment is critical for bug fixing or tracking down issues.<p>With frontend code, it is often possible to visually check for frontend features such as menu items or visible features that only appear in a specific code version. Visually checking is time-consuming and doomed to failure in most cases.<p>A better approach is to render something unique and unambiguous into the markup like the git commit hash of the HEAD commit that is rendered into an invisible div below:<p><img alt=\"git hash in hidden div\"src=https://res.cloudinary.com/ddospxsc8/image/upload/v1692535661/guid_rbdtxs.png><p>A git commit hash is a perfect identifier to pinpoint what version of the code is in the current environment. This git commit hash is the current ID of the current HEAD when the code was deployed.<p>The hash in the markup can then be an input for the <a href=https://git-scm.com/docs/git-show>git show command</a>, which can display a nice git diff of precisely which commit this hash is pointing at.<p><img alt=\"git show result\"src=https://res.cloudinary.com/ddospxsc8/image/upload/v1692890916/git-show2_pvhq29.png><h2>What makes a suitable identifier?</h2><p>I used to parse the version of the code from the package.json file, but this is only sometimes reliable. The version number field of a <code>package.json</code> file will probably not get updated on each commit, while a git commit hash certainly will.<h2>CI/CD pipeline is the only place where environment variables should be assigned values</h2><p>Checking <code>.env</code> files of anything into source control will soon become a security hazard. The retrieval and setting of environment variable values should be part of the continuous integration/deployment process (CI/CD), even for something as seemingly innocuous as a git commit hash. Please do not rely on a developer to set this value before each deploy. Every value must be assigned as part of the automated release process.<p>In this example, the git commit hash is rendered into a <a href=https://remix.run/docs/en/main>remix-run</a> application that deploys to AWS using <a href=https://arc.codes/docs/en/get-started/quickstart>aws architect</a>.<p>There are a few steps to getting this value into the remix application.<p>The following github action sets an environment variable called <code>GIT_COMMIT</code> and makes the variable available to the aws architect runtime:<pre class=language-yml><code class=\"code-highlight language-yml\"><span class=\"code-line line-number\"line=1><span class=\"token punctuation\">-</span> <span class=\"token atrule key\">name</span><span class=\"token punctuation\">:</span> run architect deploy\n</span><span class=\"code-line line-number\"line=2>  <span class=\"token atrule key\">if</span><span class=\"token punctuation\">:</span> github.ref == 'refs/heads/main' <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> startsWith(github.ref<span class=\"token punctuation\">,</span> 'refs/tags/v') <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> github.event_name == 'pull_request'\n</span><span class=\"code-line line-number\"line=3>  <span class=\"token atrule key\">working-directory</span><span class=\"token punctuation\">:</span> apps/frontendsupport\n</span><span class=\"code-line line-number\"line=4>  <span class=\"token atrule key\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token string scalar\">\n</span></span><span class=\"code-line line-number\"line=5><span class=\"token string scalar\">    FLAGS=\"\"\n</span></span><span class=\"code-line line-number\"line=6><span class=\"token string scalar\">    if [[ \"${{ startsWith(github.ref, 'refs/tags/v') }}\" == true ]]; then\n</span></span><span class=\"code-line line-number\"line=7><span class=\"token string scalar\">      FLAGS=\"--production\"\n</span></span><span class=\"code-line line-number\"line=8><span class=\"token string scalar\">    else\n</span></span><span class=\"code-line line-number\"line=9><span class=\"token string scalar\">      FLAGS=\"--staging\"\n</span></span><span class=\"code-line line-number\"line=10><span class=\"token string scalar\">    fi</span>\n</span><span class=\"code-line line-number\"line=11>\n</span><span class=\"code-line line-number highlight-line\"line=12>    GIT_COMMIT=\"$(git rev<span class=\"token punctuation\">-</span>parse HEAD)\" pnpm arc deploy $FLAGS <span class=\"token punctuation\">-</span>v <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>prune\n</span><span class=\"code-line line-number\"line=13>  <span class=\"token atrule key\">env</span><span class=\"token punctuation\">:</span>\n</span><span class=\"code-line line-number\"line=14>    <span class=\"token atrule key\">NODE_ENV</span><span class=\"token punctuation\">:</span> production\n</span></code></pre><p>An aws architect <a href=https://arc.codes/docs/en/guides/plugins/set>set plugin</a> is registered in the <code>app.arc</code> file:<pre class=language-yml><code class=\"code-highlight language-yml\"><span class=code-line>@plugins\n</span><span class=code-line>set<span class=\"token punctuation\">-</span>env\n</span></code></pre><p>The above configuration will tell the aws architect runtime to expect a file named <code>set-env.js</code> to be at the path <code>src/plugins/set-env</code>.<div class=remark-code-title>src/plugins/set-env.js</div><pre class=language-js><code class=\"code-highlight language-js\"><span class=code-line>module<span class=\"token punctuation\">.</span><span class=\"token property-access\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n</span><span class=code-line>  <span class=\"token literal-property property\">set</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n</span><span class=code-line>    <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> arc<span class=\"token punctuation\">,</span> inventory <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=code-line>      <span class=\"token keyword control-flow\">return</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line highlight-line\">        <span class=\"token constant\">GIT_COMMIT</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span><span class=\"token property-access\">env</span><span class=\"token punctuation\">.</span><span class=\"token constant\">GIT_COMMIT</span><span class=\"token punctuation\">,</span>\n</span><span class=code-line>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</span><span class=code-line>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</span><span class=code-line>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</span><span class=code-line><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</span></code></pre><p>AWS architect will thankfully ignore <code>.env</code> files and this is the only place where secrets should be accesed and assigned to environment variables. The above code is called a <a href=https://arc.codes/docs/en/guides/plugins/set#set.env>set.env plugin</a> that registers environment variables to all lambdas in the aws architect project.<p>If you really must use some form of .env file then the file should be created on the CI/CD server:<pre class=language-yml><code class=\"code-highlight language-yml\"><span class=\"code-line line-number\"line=1><span class=\"token punctuation\">-</span> <span class=\"token atrule key\">name</span><span class=\"token punctuation\">:</span> Create .env file\n</span><span class=\"code-line line-number\"line=2>  <span class=\"token atrule key\">working-directory</span><span class=\"token punctuation\">:</span> apps/frontendsupport\n</span><span class=\"code-line line-number\"line=3>  <span class=\"token atrule key\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token string scalar\">\n</span></span><span class=\"code-line line-number\"line=4><span class=\"token string scalar\">    cat &#60&#60 EOF > \".env\"\n</span></span><span class=\"code-line line-number highlight-line\"line=5><span class=\"token string scalar\">    GIT_COMMIT=\"$(git rev-parse HEAD)\"\n</span></span><span class=\"code-line line-number\"line=6><span class=\"token string scalar\">    EOF</span>\n</span></code></pre><p>Once the environment variable is set, it is available in the application, depending on the build/deployment framework. Remix has the concept of <a href=https://remix.run/docs/en/1.19.3/route/loader>loader functions</a> on the server that provides data to the component rendering the current route<pre class=language-ts><code class=\"code-highlight language-ts\"><span class=code-line><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">loader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=code-line>  <span class=\"token keyword\">return</span> <span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n</span><span class=code-line>    <span class=\"token constant\">ENV</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"code-line highlight-line\">      <span class=\"token constant\">GIT_COMMIT</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GIT_COMMIT</span><span class=\"token punctuation\">,</span>\n</span><span class=code-line>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</span><span class=code-line>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=code-line><span class=\"token punctuation\">}</span>\n</span></code></pre><p>The hash is then rendered into the markup.<pre class=language-ts><code class=\"code-highlight language-ts\"><span class=code-line><span class=\"token operator\">&lt;</span>div style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> display<span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">.</span><span class=\"token constant\">ENV</span><span class=\"token punctuation\">.</span><span class=\"token constant\">GIT_COMMIT</span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n</span></code></pre><p>Every time a commit triggers a build, the hash will be unique and will be automatically rendered into the markup in a div that is invisible to the naked eye.<p>Knowing the exact code version of any frontend code is now easy.<p>I have been using this trick for a long time and find it invaluable when determining which version of the code is in which environment.",
  "frontmatter": {
    "meta": {
      "title": "How to pinpoint which version of the code is running in any environment",
      "description": "Being able to tell at a glance which version of the code is in which environment is critical.",
      "date": "2023-08-24T00:00:00.000Z",
      "image": "https://res.cloudinary.com/ddospxsc8/image/upload/v1692637878/versioning_gsg8au.png",
      "tags": ["github-actions", "continuous-integration", "devops"]
    }
  }
}
