"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.onceEmit = exports.once = void 0;
const core_1 = require("@effection/core");
const event_source_1 = require("./event-source");
/**
 * Takes an event source and event name and returns an
 * {@link effection:Operation} that produces the value emitted by that
 * event. Both {@link EventTarget} and {@link EventEmitter} are
 * supported.
 *
 * ### Example
 *
 * ``` javascript
 * let start = yield once(document, 'dragstart');
 * console.log(`drag started at (${start.pageX}, ${start.pageY})`);
 *
 * let end = yield once(document, 'dragend');
 * console.log(`drag ended at (${end.pageX}, ${end.pageY})`);
 * ```
 *
 * ### Example
 *
 * ``` javascript
 * let src = yield once(stream, 'pipe');
 * ```
 *
 * @param source an object which emits events
 * @param eventName the name of the event to subscribe to
 * @typeParam T the type of the argument to the emitted event
 */
function once(source, eventName) {
    return core_1.withLabels((task) => {
        let { future, resolve } = core_1.createFuture();
        let listener = (...args) => { resolve(args[0]); };
        event_source_1.addListener(source, eventName, listener);
        task.consume(() => event_source_1.removeListener(source, eventName, listener));
        return future;
    }, { name: `once`, eventName, source: source.toString() });
}
exports.once = once;
/**
 * Exactly like {@link once | once()} except the value produced is an
 * array of all the arguments passed when the event was
 * dispatched.
 *
 * In very rare cases, some event emitters pass multiple arguments to
 * their event handlers. For example the [ChildProcess](https://nodejs.org/api/child_process.html) in
 * NodeJS emits both a status code _and_ a signal to the 'exit'
 * event. It would not be possible to read the signal from the `exit`
 * event using just the `once()` operation, so you would need to use
 * the `onceEmit()` operation to get all the arguments sent to the
 * event handler as an array.
 *
 * While it is supported, you should never need to use `onceEmit()` on an
 * `EventTarget` since only a single argument is ever passed to its event
 * handler. In those cases, always use {@link once | once()}
 *
 * ### Example
 *
 * ```javascript
 * let [exitCode, signal] = yield onEmit(childProcess, 'exit');
 * ```
 *
 * @param source an object which emits events
 * @param eventName the name of the event to subscribe to
 * @typeParam TArgs the type of the array of arguments to the emitted event
 */
function onceEmit(source, eventName) {
    return core_1.withLabels((task) => {
        let { future, resolve } = core_1.createFuture();
        let listener = (...args) => { resolve(args); };
        event_source_1.addListener(source, eventName, listener);
        task.consume(() => event_source_1.removeListener(source, eventName, listener));
        return future;
    }, { name: `onceEmit`, eventName, source: source.toString() });
}
exports.onceEmit = onceEmit;
//# sourceMappingURL=once.js.map